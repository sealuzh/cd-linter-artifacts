image: archlinux/base

stages:
  - test
  - deploy

testbench (py3):
  stage: test
  before_script:
    - pacman -Syu --noconfirm gcc glpk python-cvxopt python-numpy python-pip
    - pip install swiglpk smcp
  script:
    - python ./test.py -vv -s cvxopt glpk smcp

testbench (py2):
  stage: test
  before_script:
    - >
      pacman -Syu --noconfirm
      gcc glpk python2-coverage python2-numpy python2-pip python2-setuptools
      swig which
    - pip2 install cvxopt swiglpk smcp
  script:
    - python2 ./test.py -vv -s cvxopt glpk smcp

doctest:
  stage: test
  before_script:
    - >
      pacman -Syu --noconfirm
      m2r python-cvxopt python-matplotlib python-networkx python-numpy
      python-pip python-sphinx python-sphinx_rtd_theme
    - pip install sphinx-automodapi
  script:
    - sphinx-build -b doctest doc doctest
    # Work around https://github.com/astropy/sphinx-automodapi/issues/69: Run
    # doctests twice as the first run does not test autogenerated documents.
    - sphinx-build -b doctest doc doctest

pypi:
  stage: deploy
  before_script:
    - pacman -Syu --noconfirm git twine
  script:
    - ./setup.py sdist
    - twine upload --skip-existing dist/*
  only:
    - master
    - pypi

anaconda:
  stage: deploy
  before_script:
    # Install Miniconda from the AUR.
    - pacman -Syu --noconfirm audit fakeroot grep tar wget
    - wget https://aur.archlinux.org/cgit/aur.git/snapshot/miniconda3.tar.gz
    - tar xf miniconda3.tar.gz
    - cd miniconda3
    - useradd makepkg # makepkg refuses to run as root.
    - chown makepkg . # makepkg needs to write here.
    - PKGEXT=".pkg.tar" su makepkg -c makepkg # Don't compress the package.
    - pacman -U --noconfirm miniconda3-*.pkg.*
    - cd ..
    - ln -s /opt/miniconda3/etc/profile.d/conda.sh /etc/profile.d/conda.sh
  script:
    - ./conda/release.sh
  only:
    - master
    - conda

pages:
  stage: deploy
  before_script:
    # Install PICOS dependencies.
    - >
      pacman -Syu --noconfirm
      git glpk graphviz m2r python-cvxopt python-matplotlib python-networkx
      python-numpy python-pip python-scipy python-sphinx python-sphinx_rtd_theme
      texlive-most
    - pip install sphinx-automodapi swiglpk
  script:
    - sphinx-build -b html doc html
    - mkdir public
    - mv html/* public
  artifacts:
    paths:
      - public
  only:
    - master
    - doc

pdfdoc:
  stage: deploy
  before_script:
    - >
      pacman -Syu --noconfirm
      git glpk graphviz make m2r python-cvxopt python-matplotlib
      python-networkx python-numpy python-pip python-scipy python-sphinx
      python-sphinx_rtd_theme texlive-most
    - pip install sphinx-automodapi swiglpk
  script:
    - make -C doc latexpdf
    - mv doc/build/latex/picos*.pdf .
  artifacts:
    name: picos-doc
    paths:
      - picos*.pdf
  only:
    - master
    - pdfdoc

# vi:ts=2:et:ai

