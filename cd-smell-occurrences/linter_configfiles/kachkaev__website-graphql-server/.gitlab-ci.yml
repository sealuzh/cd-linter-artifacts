stages:
  - build-app
  - build-image

build app:
  stage: build-app
  image: node:10
  script:
    - yarn
    - yarn lint
    - yarn generate-graphql-typings
    - if [ -n "$(git status --porcelain)" ]; then echo "Please run \"yarn generate-graphql-typings\" and commit the result"; exit 1; fi
    - yarn build
  cache:
    paths:
      - node_modules
  artifacts:
    paths:
      - build
    expire_in: 1 day

build image:
  stage: build-image
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker info
    - echo $CI_REGISTRY_PASSWORD | docker login --username $CI_REGISTRY_USER $CI_REGISTRY --password-stdin
    - docker pull $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG || docker pull $CI_REGISTRY_IMAGE:master || true
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA --cache-from=$CI_REGISTRY_IMAGE:$CI_BUILD_REF_NAME --cache-from=$CI_REGISTRY_IMAGE:master --shm-size 512M .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG

